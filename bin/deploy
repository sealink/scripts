#!/usr/bin/env ruby
################################################################
# Deploys a new or existing tag to EB using "eb deploy"
# Deploys to S3 if EB deployment is not applicable
# Also writes and commits version to text file
# Also checks various pre-deployment tasks
################################################################

require_relative '../deploy/gem_checker'
GemChecker.require_gem({gem_name: 'aws-sdk', gem_version: 2})
GemChecker.require_gem({gem_name: 'rugged'})

# Demand correct invocation, one argument only for tag, clean git, changelog

if ARGV.size != 1
  puts "USAGE: #{File.basename($0)} [TAG]"
  puts "TAG: tag to deploy or create on current commit"
  fail ArgumentError, "Incorrect number of arguments given."
end
TAG = ARGV[0]

unless system('git diff --staged --quiet HEAD --')
  fail "You have staged changes! Please sort your life out mate, innit?"
end

CHANGELOG_QUESTION = "Now hold on there for just a second, partner."\
  "Have you updated the changelog (y/n)?"
puts CHANGELOG_QUESTION
changelog_updated = STDIN.gets
fail 'Better hop to it then ay?' unless changelog_updated.start_with?('y')

require_relative '../deploy/s3_configuration'
s3 = S3Configuration.new
s3.verify!
apps = s3.apps
app_names = apps.map(&:key)
puts "Found application configurations. Select index of the one to deploy:"
longest_key = app_names.max_by(&:length)
app_names.each_with_index do |app, index|
  printf "%-#{longest_key.length}s %s\n", app.sub('/',''), index
end
app_index = Integer(STDIN.gets)
app = apps.detect { |app| app.key == app_names[app_index] }
app_name = app.key.sub('/','')
puts "App \"#{app_name}\" selected."

eb = EBConfiguration.new(app_name)
# TODO: Don't call out to bash, just call local classes to deploy
if eb.exists?
  fail "Environment NOT READY!" unless eb.ready?
  puts "App is #{eb.environment_info.application_name} is on the Bean."
  puts "You've asked to deploy version #{TAG}"
  puts "Let's deploy to the Bean"
  system("eb-deploy-tag #{TAG}")
else
  puts "Not bean, is it?"
  puts "Let's deploy to S3 then!"
  system("s3-deploy-tag #{TAG}")
end
