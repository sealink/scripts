#!/usr/bin/env ruby
################################################################
# Deploys a new or existing tag to EB using "eb deploy"
# Deploys to S3 if EB deployment is not applicable
# Also writes and commits version to text file
# Also checks various pre-deployment tasks
################################################################

# Check that we have the required gems
require_relative '../deploy/gem_checker'
GemChecker.require_gem('aws-sdk', 2) # For AWS API
GemChecker.require_gem('rugged') # For Git operations

# Demand correct invocation, one argument only for tag, clean git, changelog
if ARGV.size != 1
  puts "USAGE: #{File.basename($0)} [TAG]"
  puts "TAG: tag to deploy or create on current commit"
  fail ArgumentError, "Incorrect number of arguments given."
end
TAG = ARGV[0]

unless system('git diff --staged --quiet HEAD --')
  fail "You have staged changes! Please sort your life out mate, innit?"
end

CHANGELOG_QUESTION = "Now hold on there for just a second, partner. "\
  "Have you updated the changelog (y/n)?"
puts CHANGELOG_QUESTION
changelog_updated = STDIN.gets
fail 'Better hop to it then ay?' unless changelog_updated.start_with?('y')

# Set up AWS params, i.e. region.
require_relative '../deploy/aws_settings'
AwsSettings.set_region!

# Pull in and verify our deployment configurations
require_relative '../deploy/deployable/configuration'
configuration = Configuration.new
puts "Checking available configurations... Please wait..."
configuration.verify!
puts "Check done."
# Have the user decide what to deploy
apps = configuration.apps
app_names = apps.map(&:key)
puts "Found applications. Select index of the one to deploy:"
longest_key = app_names.max_by(&:length)
app_names.each_with_index do |app, index|
  printf "%-#{longest_key.length}s %s\n", app.sub('/',''), index
end
app_index = Integer(STDIN.gets)
app = apps.detect { |app| app.key == app_names[app_index] }
app_name = app.key.sub('/','')
puts "App \"#{app_name}\" selected."

require_relative '../deploy/deployable/application'
require_relative '../deploy/deployable/eb_platform'
require_relative '../deploy/deployable/s3_platform'
application = Application.new(app: app, tag: TAG)

require_relative '../deploy/eb_configuration'
eb = EBConfiguration.new(app)
require_relative '../deploy/s3_configuration'
s3 = S3Configuration.new(app)

# TODO: Don't call out to bash, just call local classes to deploy
if eb.exists?
  puts "App is #{eb.environment_info.application_name} is on the Bean."
  puts "You've asked to deploy version #{TAG}"
  puts "Let's deploy to the Bean."
  application.platform = EBPlatform.new
  application.platform_config = eb
else
  puts "Not bean, is it?"
  puts "Let's deploy to S3 then!"
  application.platform = S3Platform.new
end
puts "Commencing deployment of #{application}."
puts "Confirm? (y/n)"
application.deploy
puts "All done."

